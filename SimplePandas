import pyarrow.csv as pv
import numpy as np
from openpyxl import Workbook
from openpyxl.styles import PatternFill
import time
import math

def safe_value(value):
    if isinstance(value, (int, float)):
        if math.isnan(value) or math.isinf(value):
            return ""
    return str(value)

def process_csv_to_excel(input_csv, output_excel, columns_to_string, column_b_name):
    start_time = time.time()

    # Read entire CSV using pyarrow (faster than pandas for large files)
    table = pv.read_csv(input_csv)
    df = table.to_pandas()

    # Convert specified columns to string
    for col in columns_to_string:
        if col in df.columns:
            df[col] = df[col].astype(str)

    # Create workbook and worksheet
    wb = Workbook(write_only=True)
    ws = wb.create_sheet()

    # Prepare column B data
    column_b_index = df.columns.get_loc(column_b_name)
    column_b_data = df[column_b_name].str.split(',').to_numpy()

    # Prepare fill pattern
    yellow_fill = PatternFill(start_color="FFFF00", end_color="FFFF00", fill_type="solid")

    # Write header
    ws.append([safe_value(col) for col in df.columns])

    # Convert DataFrame to numpy array for faster access
    data = df.to_numpy()

    # Process rows
    for i, row in enumerate(data):
        excel_row = []
        columns_to_color = set(column_b_data[i])
        for j, value in enumerate(row):
            cell_value = safe_value(value)
            if df.columns[j] in columns_to_color:
                cell = ws.cell(row=i+2, column=j+1, value=cell_value)
                cell.fill = yellow_fill
            else:
                excel_row.append(cell_value)
        ws.append(excel_row)

        if (i + 1) % 10000 == 0:
            print(f"Processed {i + 1} rows...")

    wb.save(output_excel)

    end_time = time.time()
    print(f"Processing completed in {end_time - start_time:.2f} seconds")

# Example usage
input_csv = 'huge_file.csv'
output_excel = 'output_file.xlsx'
columns_to_string = ['Column1', 'Column2']
column_b_name = 'ColumnB'  # Replace with the actual name of your column B

process_csv_to_excel(input_csv, output_excel, columns_to_string, column_b_name)
